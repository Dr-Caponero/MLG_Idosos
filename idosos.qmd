---
title: "Caducidade em Idosos"
author: "Camille Menezes, Jeff Caponero e Michel Miler"
format:
    pdf:
      toc: true
      toc-title: Sumário
      colorlinks: true
      documentclass: report
      papersize: letter
      number-sections: false
      geometry:
        - top=30mm
        - left=30mm
        - right=20mm
        - bottom=20mm
        - heightrounded
      fig-pos: "H"
      fig-align: center
      lang: pt-BR
      # fontfamily: libertinus
      fontsize: 12pt
      include-in-header:
      - text: |
          \usepackage{caption}
          \usepackage{fontspec}
          \usepackage{xcolor}
          \usepackage{indentfirst}
          \captionsetup[table]{name=Tabela}
editor: 
  markdown: 
    wrap: 72
---

```{r pacotes&dados}
#| echo: false
#| warning: false

library(pacman)
library(GGally)
pacman::p_load(tidyverse,  readit, summarytools,
               kableExtra,  ggpubr,  gridExtra, 
               glue, corrplot,  readxl, writexl, ggthemes,
               patchwork,  plotly, gglm, ggplot2, tidymodels)

dados <- read_excel("idosos.xlsx")
dados$resp <- as.factor(dados$resp)
dados2 <- NULL
Com <- dados |> filter(resp==1)
Sem <- dados |> filter(resp==0)
```

## Introdução

Cinquenta e quatro indivíduos considerados idosos são submetidos a um
exame psiquiátrico para avaliar a ocorrência ou não de sintoma de
caduquice. (Agresti, 1990, pgs. 122-123). Acredita-se que o escore
obtido num exame psicológico feito previamente esteja associado com a
ocorrência ou não do sintoma. Este trabalho propõe um modelo de
regressão logística para estudar esta relação.

## Análise descritiva

Conduziu-se uma análise descritiva dos dados, com objetivo de entender
um pouco mais as variáveis consideradas.

```{r}
#| echo: false
#| warning: false
#| mensage: false

tab_com <- Com|>
   summarytools::descr(
    stats = c("min", "q1", "med", "mean","q3", "max",  "sd", "cv", "Skewness", "Kurtosis"),
    justify = "c",
    style = "rmarkdown",
    transpose = T)
tab_sem <- Sem|>
   summarytools::descr(
    stats = c("min", "q1", "med", "mean","q3", "max",  "sd", "cv", "Skewness", "Kurtosis"),
    justify = "c",
    style = "rmarkdown",
    transpose = T)

tab <- rbind(tab_com,tab_sem)
rownames(tab) <- c("Com Caducância", "Sem Caducância")
tab|>
    kbl(
    caption = "Tabela com as estatísticas-resumo para a variável score dos idosos com ou sem caducância",
    digits = 2,
    label = 'tbl-t1' ,
    format.args=list(big.mark=".", decimal.mark=","),
    align = "c", row.names = T, booktabs = T
  )|>
  kable_styling(
    full_width = F, position = 'center', 
    latex_options = c("striped", "HOLD_position", "scale_down", "repeat_header")
  )|>
  column_spec(1, bold = T
              )|>
  kable_material()

```

Na Tabela 1, é possível observar que a média dos scores para os idosos
com caducância é menor do que para os sem caducância. A média e a
mediana para ambos cenários aparentam estar bem próximas entre si, além
da métrica de simetria estar próxima de zero, indicando que a
distribuição dos scores é simétrica para os idosos com ou sem
caducância. Para a curtose, é notável que a distribuição dos scores para
os idosos com caducância é mais platicúrtica que para os idosos sem
caducância.

```{r}
#| echo: false
#| warning: false
#| mensage: false
#| fig-cap: "Boxplot para a variável score dos idosos com ou sem caducância"
#| label: fig-f1
p <- ggplot(dados, aes(x=resp, y=score)) + 
  geom_boxplot()
p

```

Através dos boxplots da @fig-f1, é possível observar que para os idosos
sem caducância, existe uma maior variabilidade dos scores abaixo da
mediana, enquanto que para os scores dos com caducância há uma
variabilidade maior entre a mediana e o terceiro quartil. Tanto pela
Tabela 1 quanto pela @fig-f1, já é possível notar que há uma tendência a
qual menores scores estão mais associados com idosos com caducância.

## Modelo

Queremos analisar como o valor do score obtido no exame psicológico impacta na chance de idoso apresentar caducância ou não. Desse modo, o modelo a ser definido será o modelo MLG binomial com função de ligação logito, então sendo $Y_{i}$ a variável que indica se o idoso "i" apresenta caducância ou não, temos que

* $Y_{i}\sim Binomial(1,\mu_{i})$
* $log(\frac{\mu_{i}}{1-\mu_{i}}) = \alpha + \beta x_{i}$

onde que

* $x_{i}$ é a variável score
* $\frac{\mu_{i}}{1-\mu_{i}}$ é a chance
* $\alpha$ é o efeito escalar no logarítmo da chance do idoso apresentar caducância 
* $\beta$ é efeito no logarítmo da chance do idoso apresentar caducância quando uma unidade é adicionada na variável score
* $exp(\beta)$ é efeito na razão da chance do idoso apresentar caducância quando uma unidade é adicionada na variável score



Com base nos dados é possível avaliar um modelo de regressão logistico.

```{r}
#| echo: false
#| warning: false

fit_l <- glm(resp~score, data=dados, family = binomial(link="logit"))
tab_l <- summary(fit_l)
tab_l <- tab_l$coefficients
rownames(tab_l) <- c("Intercepto", "Beta 1")
colnames(tab_l) <- c("Estimado", "SD", "z", "Pr(>|z|)")
parametros_l <- confint(fit_l)
#anova_l <- round(anova_l,3)
tab_l %>%
  kbl(
    caption = "Resultados da ANOVA, para o modelo com função de ligação logito.",
    digits = 4,
    format.args=list(big.mark=".", decimal.mark=","),
    align = "c", 
    row.names = T,
  ) %>%
  kable_styling(
    full_width = F, position = 'center', 
    latex_options = c("striped", "HOLD_position", "repeat_header")
  )|>
  column_spec(1, bold = T
  )|>
  kable_material()
```

```{r }
#| echo: false
#| warning: false

fit_p <- glm(resp~score, data=dados, family = binomial(link="probit"))
tab_p <- summary(fit_p)
tab_p <- tab_p$coefficients
rownames(tab_p) <- c("Intercepto", "Beta 1")
colnames(tab_p) <- c("Estimado", "SD", "z", "Pr(>|z|)")
parametros_p <- confint(fit_p)
tab_p %>%
  kbl(
    caption = "Resultados da ANOVA, para o modelo com função de ligação probito.",
    digits = 4,
    format.args=list(big.mark=".", decimal.mark=","),
    align = "c", 
    row.names = T,
  ) %>%
  kable_styling(
    full_width = F, position = 'center', 
    latex_options = c("striped", "HOLD_position", "repeat_header")
  )|>
  column_spec(1, bold = T
  )|>
  kable_material()
```

```{r}
#| echo: false
#| warning: false

fit_c <- glm(resp~score, data=dados, family = binomial(link="cauchit"))
tab_c <- summary(fit_c)
tab_c <- tab_c$coefficients
rownames(tab_c) <- c("Intercepto", "Beta 1")
colnames(tab_c) <- c("Estimado", "SD", "z", "Pr(>|z|)")
parametros_c <- confint(fit_c)
tab_c %>%
  kbl(
    caption = "Resultados da ANOVA, para o modelo com função de ligação cauchit.",
    digits = 4,
    format.args=list(big.mark=".", decimal.mark=","),
    align = "c", 
    row.names = T,
  ) %>%
  kable_styling(
    full_width = F, position = 'center', 
    latex_options = c("striped", "HOLD_position", "repeat_header")
  )|>
  column_spec(1, bold = T
  )|>
  kable_material()
```

Os modelos apresentados nas tabelas 2, 3 e 4 são bastante similares. Uma
comparação mais acurada dos modelos pode ser verificada a partir dos
valores de AIC atingidos. A Tabela 5 mostra esses valores.

```{r}
#| echo: false
#| warning: false

aic_l <- summary(fit_l)[5]
aic_p <- summary(fit_p)[5]
aic_c <- summary(fit_c)[5]
aic_l <- as.numeric(aic_l)
aic_p <- as.numeric(aic_p)
aic_c <- as.numeric(aic_c)
aic_l <- round(aic_l,4)
aic_p <- round(aic_p,4)
aic_c <- round(aic_c,4)

tab <- cbind(c("Logito", "Probito", "Cauchit"), c(aic_l,aic_p,aic_c))
colnames(tab) <- c("Função", "AIC")

tab %>%
  kbl(
    caption = "Valores de AIC dos modelos da ANOVA, para cada função de ligação.",
    digits = 4,
    format.args=list(big.mark=".", decimal.mark=","),
    align = "c", 
    row.names = F,
  ) %>%
  kable_styling(
    full_width = F, position = 'center', 
    latex_options = c("striped", "HOLD_position", "repeat_header")
  )|>
  column_spec(1, bold = T
  )|>
  kable_material()
```

Desta forma, verifica-se que a diferença entre os modelos é bastante
sutil e não há necessidade de se valer de uma função de ligação
diferente da canônica para explicar os dados. Assim a função de ligação
logito é preferível dentre as demais.

## Resultados Inferenciais.

### Estimativas pontuais

Com base no modelo escolhido é possível estimar os valores de $\beta$ e
$\phi$ para o modelo.

```{r}
#| echo: false
#| warning: false

Y <- as.numeric(dados$resp)-1
X <- dados$score
n <- length(Y)
xx <- cbind(1,X)
phi <- n

#chute inicial
alpha <- 1
beta <- 0.1

# inicio das iterações
k <- 0
while(TRUE){
    k <- k+1
    eta <- alpha + beta*X
    mu <- exp(eta)/(1-exp(eta))
    V <- diag((mu)*(1-mu))
    W <- V
    Kbb <- phi*t(xx)%*%W%*%xx
    Kbb_inv <- solve(Kbb)
    z <- eta + solve(V)%*%(Y-mu)
    beta_it <- phi*Kbb_inv%*%t(xx)%*%W%*%z
    if(beta_it[1]-alpha<0.000001 & beta_it[2]-beta<0.000001) break
    alpha <- beta_it[1]
    beta <- beta_it[2]
}
```

Os valores estimados foram de $\alpha =$ `r round(alpha,4)` e de
$\beta_1 =$ `r round(beta,4)`. Com `r k` iterações obteve-se a precisão
de $10^{-6}$.

### Discussão dos resultados

Interpretação dos resultados.

### Função Desvio

Interpretação da função desvio. Compare o valor da função desvio com a
estatística qui-quadrado e interprete o resultado do teste de hipótese.

### Gráficos

Apresente o gráfico da função de distribuição acumulada logística (veja
Aula prática III - dados turbine). Plote o gráfico de $\hat z$ versus
$\hat \eta$ e comente sobre as evidências de adequacidade da função de
ligação.

### Análise Residual.

Considerando os resíduos Studentizado (tsi) padronizado e o componente
do desvio padronizado (tdi) apresente os seguintes gráficos tsi, tdi
versus valores ajustados, tsi , tdi versus valores observados e os
respectivos gráficos do envelope simulado.

```{R}
#| echo: false
#| warning: false
# Gráficos td tg ts2 e ld
fit <- fit_l
X <- model.matrix(fit)
n <- nrow(X)
p <- ncol(X)
w <- fit$weights
W <- diag(w)
H <- solve(t(X)%*%W%*%X)
H <- sqrt(W)%*%X%*%H%*%t(X)%*%sqrt(W)
h <- diag(H)
ts <- resid(fit,type="pearson")/sqrt(1-h)
ts2 <- (ts^2)
td <- resid(fit,type="deviance")/sqrt(1-h)
di <- (h/(1-h))*(ts^2)
tg <- sign(td)*sqrt((1-h)*(td^2)+h*(ts2))
a <- max(td)
b <- min(td)


ggplot() +
  aes(x=fitted(fit), y = td)+
  geom_point()+
  labs(x = "Valores ajustados", y = "Resíduo Componente do Desvio")+
 theme_bw() | 

ggplot() +
  aes(x=fitted(fit), y = ts)+
  geom_point()+
  labs(x = "Valores ajustados", y = "Resíduo Studentizado")+
  theme_bw() 
```

```{R}
#| echo: false
#| warning: false

obs <- 1:54
ggplot() +
  aes(x = obs, y = td)+
  geom_point()+
  labs(x = "Observações", y = "Resíduo Componente do Desvio")+
  theme_bw() |

ggplot() +
  aes(x = obs, y = ts)+
  geom_point()+
  labs(x = "Observações", y = "Resíduo Studentizado") +
  theme_bw()
```

### Observações Atípicas

Identifique as observações atípicas. Comente cada gráfico.






